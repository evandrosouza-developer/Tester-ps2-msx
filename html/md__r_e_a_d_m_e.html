<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tester-ps2-msx: STM32: PS/2 to MSX Converter Tester</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Tester-ps2-msx<span id="projectnumber">&#160;1.0.0</span>
   </div>
   <div id="projectbrief">Tester for PS/2 to MSX Keyboard Adapter</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">STM32: PS/2 to MSX Converter Tester </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This code was made to support both Blue Pill and Black Pill and it is part of the PS/2 to MSX Converter Enviroment, all of them in my github page, that consists: </p><div class="fragment"><div class="line">1)The PS/2 to MSX Converter itself, which contains:</div>
<div class="line">1.1) The firmware with source files;</div>
<div class="line">1.2) Schematics and PCB design:</div>
<div class="line">1.2.1) Electronics part Schematics with Kicad files;</div>
<div class="line">1.2.2) Single sided PCB layout with Kicad files and complete set of Gerber files;</div>
<div class="line"> </div>
<div class="line">2)The PS/2 to MSX Converter Tester, which contains:</div>
<div class="line">2.1) The firmware with source files;</div>
<div class="line">2.2) Schematics design with Kicad files;</div>
<div class="line"> </div>
<div class="line">3) Toll to create/modify the Database (Translation tables to map from PS/2 Scan Codes to MSX Matrix Codes) in excel, but it has compatible macros to be executed by Libre Office, Open Office, Star Office and so on.</div>
<div class="line"> </div>
<div class="line">4) Tini TTY I/O - tio (Linux app with source files) to communicate with console and easily allowing the user to use it with different keyboard layouts and languages.</div>
</div><!-- fragment --><p> In case of STM32F103C8T6 (Flash 64K RAM 20K) Blue Pill, you have to aplly STM32F103C6T6 (Flash 32K RAM 10K) without change anything else. In case of Black Pill, the base system is STM32F401CCy6 so, to use a more memory one, just follow the same instructions here.</p>
<p >So this firmware was developed to facilitate a Blue or Black Pill to act as a MSX keyboard sub system emulator, to test (and develop) the PS/2 to MSX keyboard Converter.</p>
<p >This updated version is USB compatible, UART running over DMA, so it uses almost 100% of the STM32F103C6T6.</p>
<p >When there is no USB host, it works at legacy (using serial 2 in Blue Pill and Serial 1 in Black Pill as console port), but when its USB is enumerated, the console port is the first logical cdcacm port on host, and the second logical port is a serial&lt;=&gt;USB converter.</p>
<p >This code is common to the two adapters I made, both based in STM32 and fits to this chip. The flash used by this implementation fits with available amount:</p>
<div class="fragment"><div class="line">$ arm-none-eabi-size tester-ps2-msxF1.elf</div>
<div class="line">   text    data     bss     dec     hex filename</div>
<div class="line">  22796    1136    3664   27596    6bcc tester-ps2-msxF1.elf</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">$ arm-none-eabi-size tester-ps2-msxF4.elf</div>
<div class="line">   text    data     bss     dec     hex filename</div>
<div class="line">  23920    1136    8268   33324    822c tester-ps2-msxF4.elf</div>
</div><!-- fragment --><p >*************** IMPORTANT NOTES ********************************************** 1) The system is configurable through a 3.3V serial console, so DO NOT use 5V or RS-232 voltage levels here, as they are going to instantly damage your board! 2) 3.3V is compatible with standard TTL Levels. </p><hr  />
<h1><a class="anchor" id="autotoc_md1"></a>
Boot screen:</h1>
<div class="fragment"><div class="line">MSX keyboard subsystem emulator based on STM32F401CCU6 miniF4 (Black Pill v2.0+)</div>
<div class="line">Serial number is XXXXXXXX</div>
<div class="line">Firmware built on MM dd yyyy hh:mm:ss</div>
<div class="line"> </div>
<div class="line">This boot was requested from NRST_pin and PowerOn. Booting...</div>
<div class="line"> </div>
<div class="line">Configuring:</div>
<div class="line">. Auxiliary message. Refer to following details.</div>
<div class="line">- 5V compatible pin ports and interrupts to interface like a real MSX;</div>
<div class="line">- High resolution timer2;</div>
<div class="line">- SysTick;</div>
<div class="line">- Ports config locking.</div>
<div class="line"> </div>
<div class="line">Boot complete! Press ? to show available options.</div>
<div class="line"> </div>
<div class="line">&gt; </div>
</div><!-- fragment --><p >Details about first configuring message:</p>
<p >=&gt;If usb is enumerated, the message will be:</p>
<ul>
<li>USB has been enumerated =&gt; Console and UART are over USB.</li>
</ul>
<p >=&gt;If usb was not enumerated, the message will be:</p>
<ul>
<li>USB host not found =&gt; Using Console over UART. Now USB is disabled</li>
</ul>
<p >=&gt;If the device does not support usb, the message will be:</p>
<ul>
<li>Non USB version. Console is over USART.</li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
Options menu:</h1>
<div class="fragment"><div class="line">(?) Available options</div>
<div class="line">1) General:</div>
<div class="line">   r (Show Running config);</div>
<div class="line">   c (Caps Lock line &lt;- On/Off/Blink);</div>
<div class="line">   k (Kana line      &lt;- On/Off/Blink);</div>
<div class="line">2) Scan related:</div>
<div class="line">   s (Scan submenu - Set first [Y Begin] and last [Y End] colunms to scan);</div>
<div class="line">   + (Increase scan rate);</div>
<div class="line">   - (Decrease scan rate);</div>
<div class="line">   p (Toggle pause scan);</div>
<div class="line">   n (Next step colunm scan)                        &lt;= when scan is paused;</div>
<div class="line">   Space (One shot scan, from [Y Begin] to [Y End]) &lt;= when scan is paused;</div>
<div class="line">3) Times / Delays / Duties:`   a) Time to read X_Scan (after Y_Scan) update:</div>
<div class="line">   &lt; (decrease by 0.25μs);</div>
<div class="line">   &gt; (increase by 0.25μs);</div>
<div class="line">   b) Read duty cycle: 1 work N idle. N may be 0 to maximum for speed:</div>
<div class="line">   i (After one sweep active read cycle, configure number of idle cycles).</div>
<div class="line">&gt; </div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md3"></a>
Dependencies</h1>
<ul>
<li><code>arm-none-eabi-gcc</code></li>
<li><code>arm-none-eabi-gdb</code></li>
<li><code>arm-none-eabi-binutils</code></li>
<li><code>stlink</code> + <code>openocd (if you want to debug)</code></li>
<li><code>libopenmcm3</code></li>
</ul>
<p >Obs.: If you plan to keep only one copy of LibopenCM3 in your computer, I really suggest you to create the variable OPENCM3_DIR in our system enviroment.</p>
<h1><a class="anchor" id="autotoc_md4"></a>
Preparations</h1>
<p >After cloning the repository you need to make the following preparations:</p>
<p >go to libopencm3 you cloned</p>
<div class="fragment"><div class="line">make TARGETS=&#39;stm32/f1 stm32/f4&#39;</div>
</div><!-- fragment --><p >Make sure you choose the right target MCU in the line 60 </p><div class="fragment"><div class="line">#define MCU                       STM32F103</div>
<div class="line">or</div>
<div class="line">#define MCU                       STM32F401</div>
<div class="line"> </div>
<div class="line">make</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md5"></a>
Hardware and Setup for Blue Pill:</h1>
<p >You will obviously need a STM32F103C6T6 or a STM32F103C8T6 chip. I have used a chinese blue pill. The software was made aiming in use of compatible processors, like GD32 for example. The software was made considering 8.000Mhz oscillator crystal, to clock the STM32 microcontroller chip at 72MHz. The connections are:</p>
<p >1) Serial console:</p>
<p >Config: 115200, 8, n, 1 (115200 bps, 8 bits, no parity, 1 stop bit;</p>
<p >Tx: A2</p>
<p >Rx: A3</p>
<hr  />
<p >Obs.: It is a only 3.3V port, compatible to TTL levels. Do not use it with "1" level higher than 3.3V!!</p>
<hr  />
<p >2) To PS/2 to MSX Adapter:</p><ul>
<li>PB8 (X0) - Connect to /X0 pin of the adapter;</li>
<li>PB9 (X1) - Connect to /X1 pin of the adapter;</li>
<li>PB10 (X2) - Connect to /X2 pin of the adapter;</li>
<li>PB11 (X3) - Connect to /X3 pin of the adapter;</li>
<li>PB12 (X4) - Connect to /X4 pin of the adapter;</li>
<li>PB13 (X5) - Connect to /X5 pin of the adapter;</li>
<li>PB14 (X6) - Connect to /X6 pin of the adapter;</li>
<li>PB15 (X7) - Connect to /X7 pin of the adapter;</li>
<li>PA4 (Y0) - Connect to Y0 pin of the adapter;</li>
<li>PA5 (Y1) - Connect to Y1 pin of the adapter;</li>
<li>PA6 (Y2) - Connect to Y2 pin of the adapter;</li>
<li>PA7 (Y3) - Connect to Y3 pin of the adapter;</li>
<li>PB5 (CAPS)- Connect to /Caps pin of the adapter;</li>
<li>PB6 (KANA)- Connect to /Kana pin of the adapter; pull-up connection.</li>
</ul>
<h1><a class="anchor" id="autotoc_md6"></a>
Hardware and Setup For Black Pill::</h1>
<p >You will obviously need a STM32F401CCU6 chip or up. I have used a chinese black pill. The software was made considering 25.000Mhz oscillator crystal, to clock the STM32 microcontroller chip at 84MHz. The connections are: 1) Serial console:</p>
<p >Config: 115200, 8, n, 1 (115200 bps, 8 bits, no parity, 1 stop bit;</p>
<p >Tx: A9</p>
<p >Rx: A10</p>
<hr  />
<p >Obs.: It is only a 5V port, compatible to TTL levels. Do not use it with "1" level higher than 5V!!</p>
<hr  />
<p >2) To PS/2 to MSX Adapter:</p><ul>
<li>PB12 (X0) - Connect to /X0 pin of the adapter;</li>
<li>PB10 (X1) - Connect to /X1 pin of the adapter;</li>
<li>PB13 (X2) - Connect to /X2 pin of the adapter;</li>
<li>PB3 (X3) - Connect to /X3 pin of the adapter;</li>
<li>PB14 (X4) - Connect to /X4 pin of the adapter;</li>
<li>PB1 (X5) - Connect to /X5 pin of the adapter;</li>
<li>PB15 (X6) - Connect to /X6 pin of the adapter;</li>
<li>PB0 (X7) - Connect to /X7 pin of the adapter;</li>
<li>PA8 (Y0) - Connect to Y0 pin of the adapter;</li>
<li>PA7 (Y1) - Connect to Y1 pin of the adapter;</li>
<li>PA6 (Y2) - Connect to Y2 pin of the adapter;</li>
<li>PA5 (Y3) - Connect to Y3 pin of the adapter;</li>
<li>PB4 (CAPS)- Connect to /Caps pin of the adapter;</li>
<li>PB6 (KANA)- Connect to /Kana pin of the adapter; pull-up connection.</li>
</ul>
<h1><a class="anchor" id="autotoc_md7"></a>
Hardware observations</h1>
<p >As no PCB will be developed for this tester, I recommend the aquisition of black pill for this function.</p>
<p >If you are goig to develop ARM, I strongly suggest the use of Black Magic Probe. It is a wonderful tool that, if you can not spend USD 75,00 in buying the orginal to support the project, its openness allow us to use a lot of different targets to do the function. Today I should recommend to use a Black Pill to do the Black Magic Probe functionality.</p>
<p >Use a ST-Link v2 Programmer (or similar), Black Magic Probe or another Serial Wire supported tool to flash the program using <code>make flash</code> onto the STM32. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
